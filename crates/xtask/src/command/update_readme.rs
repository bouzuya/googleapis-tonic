use std::fs;
use std::path::PathBuf;

use crate::state::State;

pub fn execute() -> anyhow::Result<()> {
    let state_file = PathBuf::from("crates").join("xtask").join("state.json");
    let state = State::load(&state_file)?;

    let mut table = String::new();
    let mut refs = String::new();

    table.push_str(
        r#"
| name | version | downloads |
|------|---------|-----------|
"#,
    );
    for crate_name in state.crate_versions().keys() {
        table.push_str(
            &"| [{CRATE_NAME}] | [![{CRATE_NAME}__v]][{CRATE_NAME}__c] | ![{CRATE_NAME}__d] |\n"
                .replace("{CRATE_NAME}", &crate_name.to_string()),
        );
        refs.push_str(
            &r#"
[{CRATE_NAME}]: ./generated/{CRATE_NAME}
[{CRATE_NAME}__c]: https://crates.io/crates/{CRATE_NAME}
[{CRATE_NAME}__d]: https://img.shields.io/crates/d/{CRATE_NAME}
[{CRATE_NAME}__v]: https://img.shields.io/crates/v/{CRATE_NAME}"#
                .replace("{CRATE_NAME}", &crate_name.to_string()),
        );
    }

    let path = PathBuf::from("README.md");
    let content = r#"# googleapis-tonic
Google APIs client libraries generated by tonic-build.

## Related Repositories

- <https://github.com/googleapis/googleapis>
- <https://github.com/hyperium/tonic>
- <https://github.com/matklad/cargo-xtask>

## Generated crates

{CRATE_TABLE}

{REFS}
"#
    .replace("{CRATE_TABLE}", &table)
    .replace("{REFS}", &refs);
    fs::write(path, content)?;
    Ok(())
}
